<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ENI-Enchères</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Vente terminée -->
    <th:block th:if="${article.etatVente == 'Terminée' and meilleureOffre != null}">
        <th:block th:if="${#strings.equals(meilleureOffre.acheteur.pseudo, #authentication.name)}">
            <h1>Vous avez remporté la vente !</h1>
        </th:block>
        <th:block th:if="${!#strings.equals(meilleureOffre.acheteur.pseudo, #authentication.name)}">
            <h1><span th:text="${meilleureOffre.acheteur.pseudo}"></span> a remporté l'enchère</h1>
        </th:block>
    </th:block>
    <th:block th:if="${article.etatVente == 'Terminée' and meilleureOffre == null}">
        <h1>Aucune proposition n'a été émise pendant la période d'enchère.</h1>
    </th:block>

    <!-- Vente en cours -->
    <th:block th:if="${article.etatVente == 'En cours'}">
        <h1>Détails vente</h1>
    </th:block>

    <th:block th:if="${article.etatVente == 'En cours'
                     || article.etatVente == 'Terminée'
                     || #strings.equals(article.vendeur.pseudo, #authentication.name)}">
        <!-- Une vente non commencée n'est visible que par le vendeur -->
        <div>
            <span>
                <img th:src="@{'/images/' + ${article.idImage}}"
                     th:alt="${article.idImage != null ? 'Image de ' + article.nomArticle : 'Aucune image sélectionnée'}"
                     th:if="${article.idImage != null}"
                     style="max-width: 200px; max-height: 200px;" />
                <span th:if="${article.idImage == null}" class="text-muted">
                    Aucune image sélectionnée
                </span>
            </span>

            <p>Article : <span th:text="${article.nomArticle}"></span></p>
            <p>Description : <span th:text="${article.description}"></span></p>
            <p>Catégorie : <span th:text="${article.categorie.libelle}"></span></p>
            <p>Meilleure offre :
                <th:block th:if="${meilleureOffre != null}">
                    <span th:text="${meilleureOffre.montantEnchere}"></span>
                    points par
                    <a th:href="@{/profil}" th:text="${meilleureOffre.acheteur.pseudo}"></a>
                </th:block>
                <th:block th:unless="${meilleureOffre != null}">
                    Aucune offre.
                </th:block>
            </p>
            <p>Mise à prix : <span th:text="${article.prixInitial}"></span> points</p>
            <p>Début de l'enchère : <span th:text="${#temporals.format(article.dateDebutEncheres, 'dd/MM/yyyy')}"></span></p>
            <p>Fin de l'enchère : <span th:text="${#temporals.format(article.dateFinEncheres, 'dd/MM/yyyy')}"></span></p>
            <p>
                <span>Retrait: </span>
                <span th:text="${article.retrait?.rue} ?: ''">
                    <p> <span th:text="${article.retrait?.codePostal} ?: ''"></span>
                        <span th:text="${article.retrait?.ville} ?: ''"></span>
                    </p>
                </span>
            </p>
            <p>Vendeur :
                <a th:href="@{/profil}" th:text="${article.vendeur.pseudo}"></a>
            </p>

            <!-- Un acheteur peut enchérir tant que la vente est encore en cours -->
            <form th:if="${article.etatVente == 'En cours'}" th:action="@{/vente/{id}/encherir(id=${article.noArticle})}" method="POST">
                <p>Ma proposition :
                    <input th:if="${monOffre == null}" type="number" name="nouveauMontantEnchere" th:value="0" required min="10" step="10">
                    <input th:if="${monOffre != null}" type="number" name="nouveauMontantEnchere" th:value="${monOffre.montantEnchere}" required min="10" step="10">
                    points
                    <input type="submit" value="Enchérir">
                </p>
            </form>

<!--             Si la vente est terminée, impossible de renchérir -->
            <div th:if="${article.etatVente == 'Terminée'}">
                <div th:if="${monOffre != null}">
                    <span>Ma proposition :
                        <span th:text="${monOffre.montantEnchere}"></span>
                        points
                    </span>
                </div>
            </div>

            <!-- Si la vente n'est pas encore commencée : possibilité de modifier et d'annuler la vente pour le vendeur -->
            <div th:if="${article.etatVente == 'Non commencée' && #strings.equals(article.vendeur.pseudo, #authentication.name)}" class="d-flex gap-2">
                <a th:href="@{/vente/{id}/modifier(id=${article.noArticle})}" class="btn btn-primary" >Modifier</a>
                <form th:action="@{/vente/{id}/annuler(id=${article.noArticle})}" method="POST">
                    <button type="submit" class="btn btn-warning" onclick="return confirm('Voulez-vous vraiment annuler la vente de ?');">
                        Annuler la vente
                    </button>
                </form>
            </div>

        </div>
    </th:block>
</body>
</html>